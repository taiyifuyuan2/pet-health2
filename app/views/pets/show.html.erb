<!-- ペットヘッダー -->
<div class="pet-header">
  <div class="pet-info">
    <div class="pet-avatar-large">
      <img src="<%= @pet.profile_image_url %>" alt="<%= @pet.name %>の写真" class="pet-avatar-image">
    </div>
    <div class="pet-details">
      <h1 class="pet-name"><%= @pet.name %></h1>
      <div class="pet-basic-info">
        <div class="pet-info-item">
          <span class="info-icon">
            <%= image_tag "icons/dog.jpeg", alt: "種類", class: "icon-small" %>
          </span>
          <%= @pet.species %>
        </div>
        <% if @pet.sex.present? %>
          <div class="pet-info-item">
            <span class="info-icon">
              <%= image_tag "icons/user.jpeg", alt: "性別", class: "icon-small" %>
            </span>
            <%= @pet.sex %>
          </div>
        <% end %>
        <% if @pet.birthdate.present? %>
          <div class="pet-info-item">
            <span class="info-icon">
              <%= image_tag "icons/birthday.jpeg", alt: "誕生日", class: "icon-small" %>
            </span>
            <%= @pet.birthdate.strftime('%Y年%m月%d日') %>
          </div>
        <% end %>
        <% if @pet.breed.present? %>
          <div class="pet-info-item">
            <span class="info-icon">
              <%= image_tag "icons/dog.jpeg", alt: "犬種", class: "icon-small" %>
            </span>
            <%= @pet.breed.name %>
          </div>
        <% end %>
        <% if @pet.weight_kg.present? %>
          <div class="pet-info-item">
            <span class="info-icon">
              <%= image_tag "icons/check.svg", alt: "体重", class: "icon-small" %>
            </span>
            <%= @pet.weight_kg %>kg
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <div class="pet-actions">
    <%= link_to "編集", edit_pet_path(@pet), class: "btn btn-secondary" %>
    <%= link_to "削除", @pet, data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, 
                class: "btn btn-danger" %>
  </div>
</div>

<!-- 統計カード -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/calendar.jpeg", alt: "予定", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= @events.count %></div>
      <div class="stat-label">関連予定</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/check.svg", alt: "完了", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= @events.completed.count %></div>
      <div class="stat-label">完了済み</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/clock.svg", alt: "未完了", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= @events.pending.count %></div>
      <div class="stat-label">未完了</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/house.jpeg", alt: "世帯", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number">1</div>
      <div class="stat-label">所属世帯</div>
    </div>
  </div>
</div>

<!-- メインコンテンツ -->
<div class="pet-detail-grid">
  <!-- ペット詳細情報 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "詳細", class: "icon-inline" %>
        詳細情報
      </h2>
    </div>
    <div class="pet-detail-content">
      <div class="detail-section">
        <h3 class="detail-section-title">基本情報</h3>
        <div class="detail-items">
          <div class="detail-item">
            <div class="detail-icon">
              <%= image_tag "icons/dog.jpeg", alt: "種類", class: "icon-small" %>
            </div>
            <div class="detail-content">
              <div class="detail-label">種類</div>
              <div class="detail-value"><%= @pet.species %></div>
            </div>
          </div>
          <% if @pet.sex.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/user.jpeg", alt: "性別", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">性別</div>
                <div class="detail-value"><%= @pet.sex %></div>
              </div>
            </div>
          <% end %>
          <% if @pet.birthdate.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/birthday.jpeg", alt: "誕生日", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">誕生日</div>
                <div class="detail-value"><%= @pet.birthdate.strftime('%Y年%m月%d日') %></div>
              </div>
            </div>
          <% end %>
          <% if @pet.breed.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/dog.jpeg", alt: "犬種", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">犬種</div>
                <div class="detail-value"><%= @pet.breed.name %></div>
              </div>
            </div>
          <% end %>
          <% if @pet.weight_kg.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/check.svg", alt: "体重", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">体重</div>
                <div class="detail-value"><%= @pet.weight_kg %>kg</div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
      <% if @pet.notes.present? %>
        <div class="detail-section">
          <h3 class="detail-section-title">メモ</h3>
          <div class="pet-notes">
            <p><%= @pet.notes %></p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 今日の予定 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/calendar.jpeg", alt: "今日の予定", class: "icon-inline" %>
        今日の予定
      </h2>
    </div>
    <div class="schedule-content">
      <% if @todays_schedule.any? %>
        <% @todays_schedule.each do |vaccination| %>
          <div class="schedule-item vaccination-item">
            <div class="schedule-content">
              <div class="schedule-header">
                <h4 class="schedule-title">ワクチン接種: <%= vaccination.vaccine.name %></h4>
                <span class="schedule-status pending">予定</span>
              </div>
              <div class="schedule-details">
                <div class="schedule-datetime">
                  <span class="date-icon">
                    <%= image_tag "icons/calendar.jpeg", alt: "日付", class: "icon-small" %>
                  </span>
                  <%= vaccination.due_on.strftime("%m月%d日") %>
                </div>
                <div class="schedule-description">
                  <%= vaccination.vaccine.description %>
                </div>
              </div>
            </div>
            <div class="schedule-actions">
              <%= link_to "完了", "#", class: "btn btn-sm btn-success" %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <div class="empty-icon">
            <%= image_tag "icons/check.svg", alt: "完了", class: "icon-large" %>
          </div>
          <p>今日の予定はありません</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 今週の予定 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/calendar.jpeg", alt: "今週の予定", class: "icon-inline" %>
        今週の予定
      </h2>
    </div>
    <div class="schedule-content">
      <% if @this_weeks_schedule.any? %>
        <% @this_weeks_schedule.each do |vaccination| %>
          <div class="schedule-item vaccination-item">
            <div class="schedule-content">
              <div class="schedule-header">
                <h4 class="schedule-title">ワクチン接種: <%= vaccination.vaccine.name %></h4>
                <span class="schedule-status pending">予定</span>
              </div>
              <div class="schedule-details">
                <div class="schedule-datetime">
                  <span class="date-icon">
                    <%= image_tag "icons/calendar.jpeg", alt: "日付", class: "icon-small" %>
                  </span>
                  <%= vaccination.due_on.strftime("%m月%d日") %>
                </div>
                <div class="schedule-description">
                  <%= vaccination.vaccine.description %>
                </div>
              </div>
            </div>
            <div class="schedule-actions">
              <%= link_to "詳細", "#", class: "btn btn-sm btn-secondary" %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <div class="empty-icon">
            <%= image_tag "icons/calendar.jpeg", alt: "予定", class: "icon-large" %>
          </div>
          <p>今週の予定はありません</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- AI健康アドバイス -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "AI健康アドバイス", class: "icon-inline" %>
        AI健康アドバイス
      </h2>
      <div class="card-actions">
        <button class="btn btn-sm btn-primary" onclick="loadAiAdvice()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
          </svg>
          AIアドバイスを取得
        </button>
      </div>
    </div>
    <div id="ai-advice-container" class="advice-content">
      <div class="empty-state">
        <div class="empty-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="#4F46E5"/>
          </svg>
        </div>
        <p>AIによる個別化された健康アドバイスを取得できます</p>
        <button class="btn btn-primary" onclick="loadAiAdvice()">AIアドバイスを取得</button>
      </div>
    </div>
  </div>

  <!-- AI健康相談 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "AI健康相談", class: "icon-inline" %>
        AI健康相談
      </h2>
    </div>
    <div class="ai-question-container">
      <%= render 'ai_health/ai_question_form' %>
    </div>
  </div>

  <!-- AI健康分析 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "AI健康分析", class: "icon-inline" %>
        AI健康分析
      </h2>
      <div class="card-actions">
        <button class="btn btn-sm btn-success" onclick="loadAiAnalysis()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 19C-1 5 5 -3 19 9C12 16 12 16 9 19Z" stroke="currentColor" stroke-width="2"/>
          </svg>
          健康分析を実行
        </button>
      </div>
    </div>
    <div id="ai-analysis-container" class="analysis-content">
      <div class="empty-state">
        <div class="empty-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 19C-1 5 5 -3 19 9C12 16 12 16 9 19Z" fill="#10b981"/>
          </svg>
        </div>
        <p>AIによる健康状態の総合分析を実行できます</p>
        <button class="btn btn-success" onclick="loadAiAnalysis()">健康分析を実行</button>
      </div>
    </div>
  </div>

  <!-- 従来の健康アドバイス -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "健康アドバイス", class: "icon-inline" %>
        基本健康アドバイス
      </h2>
    </div>
    <div class="advice-content">
      <% if @todays_advice.any? %>
        <% @todays_advice.each do |advice| %>
          <div class="advice-item advice-<%= advice[:priority] %>">
            <div class="advice-header">
              <h4 class="advice-title"><%= advice[:title] %></h4>
              <span class="advice-priority <%= advice[:priority] %>">
                <%= advice[:priority] == 'high' ? '重要' : '注意' %>
              </span>
            </div>
            <div class="advice-message">
              <%= advice[:message] %>
            </div>
            <div class="advice-category">
              <span class="category-tag"><%= advice[:category] %></span>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <div class="empty-icon">
            <%= image_tag "icons/check.svg", alt: "アドバイス", class: "icon-large" %>
          </div>
          <p>今日の特別なアドバイスはありません</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- クイックアクション -->
  <div class="pet-detail-card quick-actions-section">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "クイックアクション", class: "icon-inline" %>
        クイックアクション
      </h2>
    </div>
    <div class="quick-actions-grid">
      <%= link_to pets_path, class: "quick-action-card" do %>
        <div class="action-icon">
          <%= image_tag "icons/dog.jpeg", alt: "ペット", class: "icon" %>
        </div>
        <div class="action-content">
          <div class="action-title">ペット一覧</div>
          <div class="action-subtitle">すべてのペットを表示</div>
        </div>
      <% end %>
      <%= link_to dashboard_path, class: "quick-action-card" do %>
        <div class="action-icon">
          <%= image_tag "icons/check.svg", alt: "ダッシュボード", class: "icon" %>
        </div>
        <div class="action-content">
          <div class="action-title">ダッシュボード</div>
          <div class="action-subtitle">メインページに戻る</div>
        </div>
      <% end %>
      <%= link_to new_event_path(subject_type: 'Pet', subject_id: @pet.id), class: "quick-action-card" do %>
        <div class="action-icon">
          <%= image_tag "icons/calendar.jpeg", alt: "予定", class: "icon" %>
        </div>
        <div class="action-content">
          <div class="action-title">予定を追加</div>
          <div class="action-subtitle">新しい予定を作成</div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
// グローバルスコープに関数を定義
window.loadAiAdvice = function() {
  const petId = <%= @pet.id %>;
  const container = document.getElementById('ai-advice-container');
  const button = event.target;
  const originalText = button.innerHTML;
  
  button.innerHTML = '<div class="loading-spinner"></div>AIが分析中...';
  button.disabled = true;
  
  fetch(`/pets/${petId}/ai_advice`, {
    method: 'GET',
    headers: {
      'Accept': 'text/html',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    container.innerHTML = html;
  })
  .catch(error => {
    console.error('Error:', error);
    container.innerHTML = '<div class="empty-state"><p>AIアドバイスの取得に失敗しました。もう一度お試しください。</p></div>';
  })
  .finally(() => {
    button.innerHTML = originalText;
    button.disabled = false;
  });
};

window.loadAiAnalysis = function() {
  const petId = <%= @pet.id %>;
  const container = document.getElementById('ai-analysis-container');
  const button = event.target;
  const originalText = button.innerHTML;
  
  button.innerHTML = '<div class="loading-spinner"></div>AIが分析中...';
  button.disabled = true;
  
  fetch(`/pets/${petId}/ai_analysis`, {
    method: 'GET',
    headers: {
      'Accept': 'text/html',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    container.innerHTML = html;
  })
  .catch(error => {
    console.error('Error:', error);
    container.innerHTML = '<div class="empty-state"><p>AI分析の取得に失敗しました。もう一度お試しください。</p></div>';
  })
  .finally(() => {
    button.innerHTML = originalText;
    button.disabled = false;
  });
};
</script>

<style>
.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #4F46E5;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 6px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.card-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.ai-question-container {
  padding: 0;
}

.analysis-content {
  min-height: 200px;
}
</style>
