<!-- ペットヘッダー -->
<div class="pet-header">
  <div class="pet-header-background">
    <div class="pet-info">
      <div class="pet-avatar-container">
        <div class="pet-avatar-large">
          <% if @pet.profile_image.attached? %>
            <%= image_tag @pet.profile_image.variant(resize_to_fill: [120, 120]), alt: "#{@pet.name}の写真", class: "pet-avatar-image" %>
          <% else %>
            <img src="<%= @pet.profile_image_url %>" alt="<%= @pet.name %>の写真" class="pet-avatar-image">
          <% end %>
        </div>
        <div class="pet-status-badge">
          <span class="status-dot"></span>
          <span class="status-text">健康</span>
        </div>
      </div>
      <div class="pet-details">
        <h1 class="pet-name"><%= @pet.name %></h1>
        <p class="pet-subtitle"><%= @pet.species %> • <%= @pet.breed&.name || "犬種不明" %></p>
        <div class="pet-basic-info">
          <div class="pet-info-item">
            <span class="info-icon">
              <%= image_tag "icons/dog.jpeg", alt: "種類", class: "icon-small" %>
            </span>
            <span class="info-text"><%= @pet.species %></span>
          </div>
          <% if @pet.sex.present? %>
            <div class="pet-info-item">
              <span class="info-icon">
                <%= image_tag "icons/user.jpeg", alt: "性別", class: "icon-small" %>
              </span>
              <span class="info-text"><%= @pet.sex %></span>
            </div>
          <% end %>
          <% if @pet.birthdate.present? %>
            <div class="pet-info-item">
              <span class="info-icon">
                <%= image_tag "icons/birthday.jpeg", alt: "誕生日", class: "icon-small" %>
              </span>
              <span class="info-text"><%= @pet.birthdate.strftime('%Y年%m月%d日') %></span>
            </div>
          <% end %>
          <% if @pet.weight_kg.present? %>
            <div class="pet-info-item">
              <span class="info-icon">
                <%= image_tag "icons/check.svg", alt: "体重", class: "icon-small" %>
              </span>
              <span class="info-text"><%= @pet.weight_kg %>kg</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="pet-actions">
      <%= link_to "編集", edit_pet_path(@pet), class: "btn btn-secondary" %>
      <%= link_to "削除", @pet, data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, 
                  class: "btn btn-danger" %>
    </div>
  </div>
</div>

<!-- 統計カード -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/calendar.jpeg", alt: "予定", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= @events.count %></div>
      <div class="stat-label">関連予定</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/check.svg", alt: "完了", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= @events.completed.count %></div>
      <div class="stat-label">完了済み</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/clock.svg", alt: "未完了", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= @events.pending.count %></div>
      <div class="stat-label">未完了</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">
      <%= image_tag "icons/house.jpeg", alt: "世帯", class: "icon" %>
    </div>
    <div class="stat-content">
      <div class="stat-number">1</div>
      <div class="stat-label">所属世帯</div>
    </div>
  </div>
</div>

<!-- メインコンテンツ -->
<div class="pet-detail-grid">
  <!-- ペット詳細情報 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "詳細", class: "icon-inline" %>
        詳細情報
      </h2>
    </div>
    <div class="pet-detail-content">
      <div class="detail-section">
        <h3 class="detail-section-title">基本情報</h3>
        <div class="detail-items">
          <div class="detail-item">
            <div class="detail-icon">
              <%= image_tag "icons/dog.jpeg", alt: "種類", class: "icon-small" %>
            </div>
            <div class="detail-content">
              <div class="detail-label">種類</div>
              <div class="detail-value"><%= @pet.species %></div>
            </div>
          </div>
          <% if @pet.sex.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/user.jpeg", alt: "性別", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">性別</div>
                <div class="detail-value"><%= @pet.sex %></div>
              </div>
            </div>
          <% end %>
          <% if @pet.birthdate.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/birthday.jpeg", alt: "誕生日", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">誕生日</div>
                <div class="detail-value"><%= @pet.birthdate.strftime('%Y年%m月%d日') %></div>
              </div>
            </div>
          <% end %>
          <% if @pet.breed.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/dog.jpeg", alt: "犬種", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">犬種</div>
                <div class="detail-value"><%= @pet.breed.name %></div>
              </div>
            </div>
          <% end %>
          <% if @pet.weight_kg.present? %>
            <div class="detail-item">
              <div class="detail-icon">
                <%= image_tag "icons/check.svg", alt: "体重", class: "icon-small" %>
              </div>
              <div class="detail-content">
                <div class="detail-label">体重</div>
                <div class="detail-value"><%= @pet.weight_kg %>kg</div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
      <% if @pet.notes.present? %>
        <div class="detail-section">
          <h3 class="detail-section-title">メモ</h3>
          <div class="pet-notes">
            <p><%= @pet.notes %></p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 今日の予定 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/calendar.jpeg", alt: "今日の予定", class: "icon-inline" %>
        今日の予定
      </h2>
    </div>
    <div class="schedule-content">
      <% if @todays_schedule.any? %>
        <% @todays_schedule.each do |vaccination| %>
          <div class="schedule-item vaccination-item">
            <div class="schedule-content">
              <div class="schedule-header">
                <h4 class="schedule-title">ワクチン接種: <%= vaccination.vaccine.name %></h4>
                <span class="schedule-status pending">予定</span>
              </div>
              <div class="schedule-details">
                <div class="schedule-datetime">
                  <span class="date-icon">
                    <%= image_tag "icons/calendar.jpeg", alt: "日付", class: "icon-small" %>
                  </span>
                  <%= vaccination.due_on.strftime("%m月%d日") %>
                </div>
                <div class="schedule-description">
                  <%= vaccination.vaccine.description %>
                </div>
              </div>
            </div>
            <div class="schedule-actions">
              <%= link_to "完了", "#", class: "btn btn-sm btn-success" %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <div class="empty-icon">
            <%= image_tag "icons/check.svg", alt: "完了", class: "icon-large" %>
          </div>
          <p>今日の予定はありません</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 今週の予定 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/calendar.jpeg", alt: "今週の予定", class: "icon-inline" %>
        今週の予定
      </h2>
    </div>
    <div class="schedule-content">
      <% if @this_weeks_schedule.any? %>
        <% @this_weeks_schedule.each do |vaccination| %>
          <div class="schedule-item vaccination-item">
            <div class="schedule-content">
              <div class="schedule-header">
                <h4 class="schedule-title">ワクチン接種: <%= vaccination.vaccine.name %></h4>
                <span class="schedule-status pending">予定</span>
              </div>
              <div class="schedule-details">
                <div class="schedule-datetime">
                  <span class="date-icon">
                    <%= image_tag "icons/calendar.jpeg", alt: "日付", class: "icon-small" %>
                  </span>
                  <%= vaccination.due_on.strftime("%m月%d日") %>
                </div>
                <div class="schedule-description">
                  <%= vaccination.vaccine.description %>
                </div>
              </div>
            </div>
            <div class="schedule-actions">
              <%= link_to "詳細", "#", class: "btn btn-sm btn-secondary" %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <div class="empty-icon">
            <%= image_tag "icons/calendar.jpeg", alt: "予定", class: "icon-large" %>
          </div>
          <p>今週の予定はありません</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- AI健康相談 -->
  <div class="pet-detail-card">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "AI健康相談", class: "icon-inline" %>
        AI健康相談
      </h2>
    </div>
    <div class="ai-question-container">
      <%= render 'ai_health/ai_question_form' %>
    </div>
  </div>


  <!-- クイックアクション -->
  <div class="pet-detail-card quick-actions-section">
    <div class="card-header">
      <h2 class="card-title">
        <%= image_tag "icons/check.svg", alt: "クイックアクション", class: "icon-inline" %>
        クイックアクション
      </h2>
    </div>
    <div class="quick-actions-grid">
      <%= link_to pets_path, class: "quick-action-card" do %>
        <div class="action-icon">
          <%= image_tag "icons/dog.jpeg", alt: "ペット", class: "icon" %>
        </div>
        <div class="action-content">
          <div class="action-title">ペット一覧</div>
          <div class="action-subtitle">すべてのペットを表示</div>
        </div>
      <% end %>
      <%= link_to dashboard_path, class: "quick-action-card" do %>
        <div class="action-icon">
          <%= image_tag "icons/check.svg", alt: "ダッシュボード", class: "icon" %>
        </div>
        <div class="action-content">
          <div class="action-title">ダッシュボード</div>
          <div class="action-subtitle">メインページに戻る</div>
        </div>
      <% end %>
      <%= link_to new_event_path(subject_type: 'Pet', subject_id: @pet.id), class: "quick-action-card" do %>
        <div class="action-icon">
          <%= image_tag "icons/calendar.jpeg", alt: "予定", class: "icon" %>
        </div>
        <div class="action-content">
          <div class="action-title">予定を追加</div>
          <div class="action-subtitle">新しい予定を作成</div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
// AI健康相談機能のみを残す
</script>

<style>
.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #4F46E5;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 6px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.card-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.ai-question-container {
  padding: 0;
}

.analysis-content {
  min-height: 200px;
}
</style>

<script>
window.loadAiAnalysis = function() {
  const petId = <%= @pet.id %>;
  const container = document.getElementById('ai-analysis-container');
  const button = event.target;
  const originalText = button.innerHTML;

  button.innerHTML = '<div class="loading-spinner"></div>AIが分析中...';
  button.disabled = true;

  fetch(`/pets/${petId}/ai_analysis`, {
    method: 'GET',
    headers: {
      'Accept': 'text/html',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    container.innerHTML = html;
  })
  .catch(error => {
    console.error('Error:', error);
    container.innerHTML = '<div class="empty-state"><p>AI分析の取得に失敗しました。もう一度お試しください。</p></div>';
  })
  .finally(() => {
    button.innerHTML = originalText;
    button.disabled = false;
  });
};



</script>
